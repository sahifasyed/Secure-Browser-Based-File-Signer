FROM nginx:alpine

# Install OpenSSL for certificate generation
RUN apk add --no-cache openssl

# Create directory for certificates
RUN mkdir -p /etc/nginx/certs

# Generate self-signed certificate (FOR DEVELOPMENT ONLY)
# In production, use certificates from a trusted CA
RUN openssl req -x509 -nodes -days 365 -newkey rsa:3072 \
    -keyout /etc/nginx/certs/nginx.key \
    -out /etc/nginx/certs/nginx.crt \
    -subj "/C=GB/ST=England/L=London/O=CompanyX/OU=CyberSecurity/CN=myserver.com"

# Generate strong Diffie-Hellman parameters (3072-bit for NIST compliance)
# This may take several minutes
RUN openssl dhparam -out /etc/nginx/certs/dhparam.pem 3072

# Set secure permissions on private key
RUN chmod 600 /etc/nginx/certs/nginx.key
RUN chmod 644 /etc/nginx/certs/nginx.crt
RUN chmod 644 /etc/nginx/certs/dhparam.pem

# Copy nginx configuration
COPY nginx.conf /etc/nginx/nginx.conf

# Create log directory
RUN mkdir -p /var/log/nginx

# Expose both HTTP (for redirect) and HTTPS
EXPOSE 80 443

# Run nginx
CMD ["nginx", "-g", "daemon off;"]
